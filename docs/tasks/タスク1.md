# タスク1: Docker Compose 環境の構築

## 📋 タスク概要

このタスクでは、Twitterクローンアプリケーションの開発環境をDocker Composeで構築します。
これにより、以下のメリットが得られます：

- ✅ 開発環境の統一（チームメンバー全員が同じ環境で開発可能）
- ✅ CORSの問題を開発段階から解決（Nginxによるリバースプロキシ）
- ✅ 本番環境に近い構成でのローカル開発
- ✅ 簡単なセットアップ（`docker-compose up` 一発で起動）

---

## 🏗️ Docker Compose 構成案

### サービス構成

```
┌─────────────────────────────────────────────┐
│  localhost:80                               │
│  ┌───────────────────────────────────────┐  │
│  │         Nginx (リバースプロキシ)       │  │
│  └───────────────────────────────────────┘  │
│              ↓           ↓                  │
│      /api/*  │           │  /*              │
│              ↓           ↓                  │
│  ┌──────────────┐   ┌──────────────┐       │
│  │   Laravel    │   │    React     │       │
│  │  (port 9000) │   │  (port 5173) │       │
│  │  PHP-FPM     │   │  Vite        │       │
│  └──────────────┘   └──────────────┘       │
│          ↓                                  │
│  ┌──────────────┐                          │
│  │  PostgreSQL  │                          │
│  │  (port 5432) │                          │
│  └──────────────┘                          │
└─────────────────────────────────────────────┘
```

### サービス一覧

| サービス名 | 役割 | ベースイメージ | ポート |
|----------|------|--------------|-------|
| **nginx** | Webサーバー/リバースプロキシ | nginx:alpine | 80 |
| **laravel** | バックエンドAPI (Laravel 11) | php:8.2-fpm-alpine | 9000 |
| **react** | フロントエンド (React + Vite) | node:20-alpine | 5173 |
| **db** | データベース (PostgreSQL 16) | postgres:16-alpine | 5432 |

---

## 📁 生成するファイル一覧

### 1. プロジェクトルート
- `docker-compose.yml` - Docker Compose設定ファイル

### 2. Docker関連ディレクトリ（`docker/`）
```
docker/
├── nginx/
│   └── default.conf          # Nginx設定ファイル
├── laravel/
│   └── Dockerfile            # Laravel用Dockerfile
└── react/
    └── Dockerfile            # React用Dockerfile
```

### 3. アプリケーションディレクトリ（後続タスクで作成）
```
backend/                      # Laravelプロジェクト
frontend/                     # Reactプロジェクト
```

---

## 🔧 各サービスの詳細設計

### 1. Nginx（リバースプロキシ）

**役割**:
- `localhost:80` でアクセスする単一のエントリーポイント
- `/api/*` へのリクエストをLaravelに振り分け
- それ以外のリクエスト (`/`, `/login` など) をReactに振り分け
- **CORS問題の解決**: フロントエンドとバックエンドが同じオリジン（localhost:80）からアクセスされる

**設定のポイント**:
```nginx
server {
    listen 80;
    server_name localhost;

    # フロントエンド（React）へのプロキシ
    location / {
        proxy_pass http://react:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # バックエンド（Laravel）へのプロキシ
    location /api {
        proxy_pass http://laravel:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2. Laravel（バックエンド）

**ベースイメージ**: `php:8.2-fpm-alpine`

**必要な拡張機能**:
- pdo_pgsql（PostgreSQLデータベース接続）
- pgsql（PostgreSQL関数）
- mbstring（マルチバイト文字列処理）
- zip（Composerの依存関係解決）
- bcmath（精密な数値計算）
- opcache（PHPパフォーマンス向上）

**ボリュームマウント**:
- `./backend:/var/www/html` - Laravelプロジェクトディレクトリ

**環境変数**:
- `DB_CONNECTION=pgsql`
- `DB_HOST=db`
- `DB_PORT=5432`
- `DB_DATABASE=twitter_clone`
- `DB_USERNAME=laravel_user`
- `DB_PASSWORD=secret`

### 3. React（フロントエンド）

**ベースイメージ**: `node:20-alpine`

**開発サーバー**: Vite（ポート 5173）

**ボリュームマウント**:
- `./frontend:/app` - Reactプロジェクトディレクトリ
- `/app/node_modules` - node_modulesをコンテナ内に保持（パフォーマンス向上）

**Vite設定のポイント**:
```javascript
// vite.config.ts
export default defineConfig({
  server: {
    host: '0.0.0.0', // Docker内部からアクセス可能に
    port: 5173,
    watch: {
      usePolling: true, // Dockerボリュームでのファイル監視
    },
  },
});
```

### 4. PostgreSQL（データベース）

**ベースイメージ**: `postgres:16-alpine`

**環境変数**:
- `POSTGRES_USER=laravel_user`
- `POSTGRES_PASSWORD=secret`
- `POSTGRES_DB=twitter_clone`

**ボリュームマウント**:
- `db_data:/var/lib/postgresql/data` - データの永続化

**ヘルスチェック**:
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U laravel_user -d twitter_clone"]
  interval: 10s
  timeout: 5s
  retries: 5
```

**PostgreSQLを選ぶ理由**:
- ✅ 完全なオープンソース（PostgreSQL License）
- ✅ 無料で商用利用可能
- ✅ 高い信頼性と堅牢性
- ✅ Laravelで完全にサポートされている
- ✅ 将来的なライセンス変更の心配がない

---

## 🌐 ネットワーク構成

Docker Composeは、すべてのサービスを同じネットワーク（`twitter-network`）に配置します。

**サービス間通信**:
- Laravel → PostgreSQL: `db:5432`
- Nginx → Laravel: `laravel:9000`
- Nginx → React: `react:5173`

**外部アクセス**:
- ユーザー → Nginx: `localhost:80`

---

## 🔄 CORS対策の仕組み

### 従来の問題（Docker Composeなしの場合）

```
React (localhost:5173)
   ↓ APIリクエスト
Laravel (localhost:8000)
   ↓ CORS エラー！（オリジンが異なる）
```

### Docker Compose + Nginx による解決

```
ユーザー
   ↓
Nginx (localhost:80)
   ├→ / → React (同じオリジン内部で通信)
   └→ /api → Laravel (同じオリジン内部で通信)
```

**ポイント**:
- ユーザーから見ると、すべてのリクエストが `localhost:80` から来ている
- **同一オリジン** とみなされるため、CORSエラーが発生しない
- Laravel側でのCORS設定が不要（または最小限）

---

## 📝 セットアップ手順（概要）

### ステップ1: Docker設定ファイルの作成
1. `docker-compose.yml` を作成
2. `docker/nginx/default.conf` を作成
3. `docker/laravel/Dockerfile` を作成
4. `docker/react/Dockerfile` を作成

### ステップ2: Laravelプロジェクトの準備
1. `backend/` ディレクトリにLaravel 11をインストール
2. `.env` ファイルの設定（DB接続情報）
3. マイグレーションの実行

### ステップ3: Reactプロジェクトの準備
1. `frontend/` ディレクトリにReact + Vite + TypeScript + Tailwindプロジェクトを作成
2. `vite.config.ts` の設定
3. Axios の設定（APIベースURL: `/api`）

### ステップ4: Docker Composeの起動
```bash
docker-compose up -d
```

### ステップ5: 動作確認
- フロントエンド: `http://localhost:80`
- バックエンドAPI: `http://localhost:80/api`

---

## ✅ 完了条件

このタスクは、以下の条件を満たした時点で完了とします：

1. ✅ `docker-compose.yml` が作成され、4つのサービス（nginx, laravel, react, db）が定義されている
2. ✅ Nginx設定ファイルが作成され、リバースプロキシが適切に設定されている
3. ✅ Laravel用Dockerfileが作成され、必要なPHP拡張機能がインストールされている
4. ✅ React用Dockerfileが作成され、Vite開発サーバーが起動する設定になっている
5. ✅ `docker-compose up -d` でエラーなくすべてのサービスが起動する
6. ✅ `http://localhost:80` でReactアプリにアクセスできる（Hello Worldレベルで可）
7. ✅ `http://localhost:80/api/health` でLaravelのヘルスチェックエンドポイントにアクセスできる

---

## 🚀 次のステップ（タスク2以降）

タスク1が完了したら、次のステップに進みます：

### タスク2: ARCHITECTURE.md の作成
- プロジェクト全体の設計思想とベストプラクティスをドキュメント化

### タスク3: Laravel プロジェクトのセットアップ
- Laravel 11のインストール
- DDD対応のディレクトリ構成の準備
- Pest（テストフレームワーク）のセットアップ
- Laravel Pint（コードフォーマッター）のセットアップ

### タスク4: React プロジェクトのセットアップ
- React + Vite + TypeScript + Tailwindのプロジェクト作成
- Biome（リンター/フォーマッター）のセットアップ
- Vitest（テストフレームワーク）のセットアップ

### タスク5: 最初のTDDサイクル（ツイート投稿機能）
- Red: 失敗するテストを書く
- Green: テストを通す最小限の実装
- Refactor: コードの整理と最適化

---

## 📌 重要な注意事項

### 1. ステップバイステップで進める
- **一度にすべてを実装しない**
- 各タスクを完了させてから次に進む
- テストファーストの原則を守る

### 2. CLAUDE.mdの原則を守る
- TDD（レッド・グリーン・リファクタ）サイクルの厳守
- 保守性の重視（単一責任の原則、クリーンなコード）
- ベストプラクティスの遵守

### 3. 質問を躊躇しない
- 設計の意図が不明な場合は必ず質問する
- 「なぜこの実装なのか」を理解する
- トレードオフを理解する

---

**作成日**: 2025-11-16
**関連ドキュメント**: `CLAUDE.md`
**次のタスク**: `タスク2.md` (ARCHITECTURE.md の作成)
