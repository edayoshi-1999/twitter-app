# タスク5: データベース設計（コアテーブル）

## 📋 概要

### 🎯 目的

Twitterクローンアプリケーションの中核となるデータベース設計を、**正規化・制約・パフォーマンス**を注意深く考慮しながら実施しました。TDDで実装を進める前に、しっかりとしたデータモデルを設計することで、**後からの手戻りを防ぎます**。

---

## 📝 実施内容

### 1. 設計したテーブル（5つ）

| # | テーブル | 説明 | 状態 |
|---|---------|------|-----|
| 1 | `users` | ユーザー情報 | ✅ 完了（タスク3） |
| 2 | `tweets` | ツイート本文と投稿情報 | ✅ 完了（タスク3） |
| 3 | `likes` | いいね機能 | 🆕 新規設計 |
| 4 | `follows` | フォロー機能（自己参照） | 🆕 新規設計 |
| 5 | `replies` | 返信機能 | 🆕 新規設計 |

### 2. 作成したドキュメント

- **タスク5.md** (1,016行)
  - ER図（Mermaid形式）
  - テーブル設計の詳細
  - 正規化の確認（1NF, 2NF, 3NF）
  - 制約とインデックスの設計
  - マイグレーション実装例
  - 将来の拡張（リツイート、ブックマーク、DM、ハッシュタグ、メディア）

---

## 🔍 主要な設計判断

### 1. インデックス最適化

**問題**: 複合ユニーク制約がある場合、単独インデックスが重複する

**解決策**:
```php
// likesテーブル
$table->unique(['user_id', 'tweet_id']); // これが user_id 単独のクエリもカバー
$table->index('tweet_id');                // tweet_id のみ単独インデックス

// followsテーブル
$table->unique(['follower_id', 'following_id']); // これが follower_id 単独のクエリもカバー
$table->index('following_id');                    // following_id のみ単独インデックス
```

**効果**:
- ストレージ容量削減
- INSERT/UPDATE/DELETE の高速化
- インデックスメンテナンスのオーバーヘッド削減

### 2. CASCADE DELETE の影響範囲

**ユーザー削除時の連鎖削除**:
```
ユーザーAを削除
  ↓
【直接削除されるもの】
  - ユーザーAのツイート
  - ユーザーAのいいね
  - ユーザーAのフォロー関係
  - ユーザーAの返信
  ↓
【間接的に削除されるもの】
  - ユーザーAのツイートへの他人のいいね
  - ユーザーAのツイートへの他人の返信
```

**代替案**: ソフトデリート（将来の検討事項として記載）

### 3. 重要な制約

| テーブル | 制約 | 目的 |
|---------|-----|------|
| `likes` | UNIQUE(user_id, tweet_id) | 重複いいね防止 |
| `follows` | UNIQUE(follower_id, following_id) | 重複フォロー防止 |
| `follows` | CHECK(follower_id <> following_id) | 自己フォロー禁止 |

### 4. UUID vs 連番

| テーブル | 主キー | 理由 |
|---------|-------|------|
| `tweets`, `replies` | UUID | 公開URLに使うため、予測不可能性が重要 |
| `users`, `likes`, `follows` | 連番 | 内部IDなので、パフォーマンス優先 |

---

## 🚨 レビューポイント

### ✅ 正しく設計されている点

1. **正規化**: 第1〜第3正規形をすべて満たす
2. **UNIQUE制約**: 重複いいね・重複フォロー防止は完璧
3. **CHECK制約**: 自己フォロー禁止は適切
4. **外部キー制約**: すべて正しく設定
5. **カスケード削除**: 参照整合性を保証
6. **インデックス戦略**: 最適化され、無駄がない

### 📝 特筆すべき設計選択

1. **repliesテーブル**: 独立テーブル vs tweetsテーブルに統合
   - 学習のため、まずはシンプルに独立
   - 将来的に統合も検討可能

2. **ソフトデリート**: 本番環境では推奨だが、学習のため今回は実装しない

---

## 🔄 次のステップ

### タスク6: 最初のTDDサイクル（ツイート投稿機能）

1. 失敗するテストを書く（Red）
2. `users`, `tweets` のマイグレーション実行
3. 実装してテストを通す（Green）
4. リファクタリング（Refactor）

その後、必要に応じて：
- タスク7: いいね機能 → `likes` マイグレーション実行
- タスク8: フォロー機能 → `follows` マイグレーション実行
- タスク9: 返信機能 → `replies` マイグレーション実行

---

## 📊 変更の統計

| 項目 | 数値 |
|-----|-----|
| 追加ファイル | 1 |
| 総行数 | 1,016行 |
| テーブル設計 | 5テーブル |
| ER図 | 1つ（Mermaid形式） |
| マイグレーション例 | 8つ（コア3 + 将来5） |

---

## ✅ チェックリスト

- [x] ER図が完成している（Mermaid形式）
- [x] すべてのテーブル定義が明確になっている
- [x] 制約（PK, FK, UNIQUE, CHECK）がすべて定義されている
- [x] インデックス戦略が決定している
- [x] カスケード削除の方針が決定している
- [x] 正規化（1NF, 2NF, 3NF）を満たしている
- [x] セキュリティ・パフォーマンスを考慮している
- [x] 将来の拡張を考慮している
- [x] すべての変更がコミットされている
- [x] ブランチにpushされている

---

## 📚 関連ドキュメント

- `CLAUDE.md`: 開発ガイドライン全体
- `ARCHITECTURE.md`: システム設計書
- `タスク3.md`: Laravel プロジェクトのセットアップ

---

**更新履歴**:
- v2.0.0 (2025-11-16): インデックス最適化、CASCADE DELETE詳細化、将来の拡張追加
- v1.0.0 (2025-11-16): 初版リリース
